<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Transaction - MindPay</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="theme.css" />
  <style>
    #scanner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 1055; /* Higher than Bootstrap modal */
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #video-preview {
      width: 100%;
      max-width: 600px;
      height: auto;
      border-radius: 8px;
    }
    #scanner-controls {
      margin-top: 15px;
    }
    #ocr-loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 1060;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
  </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="logo-head.png" alt="FinSight Logo" class="logo-header">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div style="font-family: 'Roboto', sans-serif;" class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="input.html"><i class="fas fa-plus-circle"></i> Add Transaction</a></li>
                    <li class="nav-item"><a class="nav-link" href="history.html"><i class="fas fa-list"></i> All Transactions</a></li>
                    <li class="nav-item"><a class="nav-link" href="templates.html"><i class="fas fa-file-alt"></i> Templates</a></li>
                    <li class="nav-item"><a class="nav-link" href="budget.html"><i class="fas fa-chart-pie"></i> Budget</a></li>
                    <li class="nav-item"><a class="nav-link" href="analyze.html"><i class="fas fa-chart-line"></i> Analyze</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="myprofile.html"><i class="fas fa-user"></i> My Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="messageContainer" style="position: absolute; top: 70px; left: 30px; z-index: 9999; min-width: 250px;"></div>

    <div style="font-family: 'Roboto', sans-serif;" class="container mt-4">
        <div class="form-container">
            <div class="d-flex justify-content-center align-items-center mb-4">
                <h2 class="text-center m-0">Add Transaction</h2>
                <button id="scanReceiptBtn" class="btn btn-outline-primary ms-3">
                    <i class="fas fa-camera"></i> Scan
                </button>
            </div>

            <form id="transactionForm">
                <div class="mb-3">
                    <label for="type" class="form-label">Type</label>
                    <select class="form-select" id="type" required>
                        <option value="Expense" selected>Expense</option>
                        <option value="Income">Income</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" required></select>
                </div>
                <div class="mb-3">
                    <label for="amount" class="form-label">Amount</label>
                    <input type="number" class="form-control" id="amount" step="0.01" min="0" required />
                </div>
                <div class="mb-3">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date" required />
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment</label>
                    <textarea class="form-control" id="comment" rows="2"></textarea>
                </div>
                
                <div class="d-flex justify-content-start mb-3">
                    <div class="form-check me-4">
                        <input type="checkbox" class="form-check-input" id="recurringCheck">
                        <label class="form-check-label" for="recurringCheck">Recurring Transaction</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="saveTemplateCheck">
                        <label class="form-check-label" for="saveTemplateCheck">Save as Template</label>
                    </div>
                </div>
                <div id="recurringOptions" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="frequency" class="form-label">Frequency</label><select class="form-select" id="frequency"><option value="Daily">Daily</option><option value="Weekly">Weekly</option><option value="Monthly" selected>Monthly</option></select></div>
                        <div class="col-md-6 mb-3"><label for="instances" class="form-label">Instances</label><input type="number" class="form-control" id="instances" min="1"></div>
                    </div>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="scanner-container">
        <video id="video-preview" playsinline></video>
        <canvas id="canvas-capture" style="display: none;"></canvas>
        <div id="scanner-controls">
            <button id="captureBtn" class="btn btn-primary btn-lg me-2"><i class="fas fa-camera"></i> Capture</button>
            <button id="closeScannerBtn" class="btn btn-danger btn-lg"><i class="fas fa-times"></i> Close</button>
        </div>
    </div>

    <div id="ocr-loader" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p id="ocr-status" class="mt-3 text-primary fw-bold">Scanning receipt...</p>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script type="module">
        import { getFirestore, collection, addDoc, doc, getDoc, writeBatch, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { auth, db } from "./firebase-config.js";

        let currentUserId = null;
        let videoStream = null;
        
        const defaultIncomeCategories = ["Salary", "Gift", "Bonus", "Interest", "Business Income", "Others"];
        const defaultExpenseCategories = ["Food", "Transport", "Utilities", "Cash Withdraw", "Health", "Loans", "Clothing", "Household", "Savings", "Entertainment", "Others"];
        let userIncomeCategories = defaultIncomeCategories;
        let userExpenseCategories = defaultExpenseCategories;

        // --- MODIFICATION START ---
        // This function reads URL parameters and fills the form.
        const prefillFromTemplate = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            const category = urlParams.get('category');
            const amount = urlParams.get('amount');

            if (type && category && amount) {
                document.getElementById('type').value = type;
                
                // We must update the categories *after* setting the type to load the correct list.
                updateCategories(); 
                
                document.getElementById('category').value = category;
                document.getElementById('amount').value = parseFloat(amount).toFixed(2);

                showMessage("Loaded data from template.", "success");

                // Clean the URL to prevent re-populating on refresh.
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        };
        // --- MODIFICATION END ---


        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                await loadUserCategories(user.uid);
                updateCategories();
                await autofillLastTransactionDate(user.uid);
                prefillFromTemplate(); // Call the new function after everything is loaded.
            } else {
                window.location.href = "index.html";
            }
        });

        async function loadUserCategories(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userIncomeCategories = userData.selectedIncomeCategories || defaultIncomeCategories;
                    userExpenseCategories = userData.selectedExpenseCategories || defaultExpenseCategories;
                }
            } catch (error) { console.error("Error loading user categories:", error); }
        }

        async function autofillLastTransactionDate(userId) {
            try {
                const dateInput = document.getElementById("date");
                dateInput.value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error("Error setting today's date:", error);
                document.getElementById("date").value = new Date().toISOString().split('T')[0];
            }
        }

        const updateCategories = () => {
            const type = document.getElementById("type").value;
            const categorySelect = document.getElementById("category");
            categorySelect.innerHTML = "";
            const categories = type === "Income" ? userIncomeCategories : userExpenseCategories;
            categories.forEach(category => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        };

        window.onload = () => { updateCategories(); };
        document.getElementById("type").addEventListener("change", updateCategories);

        document.getElementById('recurringCheck').addEventListener('change', function() {
            document.getElementById('recurringOptions').style.display = this.checked ? 'block' : 'none';
        });

        const transactionForm = document.getElementById("transactionForm");
        transactionForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const type = document.getElementById("type").value;
            const category = document.getElementById("category").value;
            const amount = document.getElementById("amount").value;
            const date = document.getElementById("date").value;
            const comment = document.getElementById("comment").value;
            const isRecurring = document.getElementById("recurringCheck").checked;
            const isTemplate = document.getElementById("saveTemplateCheck").checked;

            if (!currentUserId) {
                showMessage("You must be logged in to add a transaction.", "error");
                return;
            }

            if (isRecurring) {
                const frequency = document.getElementById("frequency").value;
                const instances = parseInt(document.getElementById("instances").value);
                if (!instances || instances <= 0) {
                    showMessage("Please enter a valid number of instances for recurring transaction.", "error");
                    return;
                }
                const batch = writeBatch(db);
                const recurringId = doc(collection(db, "users")).id;
                for (let i = 0; i < instances; i++) {
                    const transactionDate = new Date(date);
                    if (frequency === 'Daily') transactionDate.setDate(transactionDate.getDate() + i);
                    else if (frequency === 'Weekly') transactionDate.setDate(transactionDate.getDate() + (i * 7));
                    else if (frequency === 'Monthly') transactionDate.setMonth(transactionDate.getMonth() + i);
                    
                    const transactionRef = doc(collection(db, "users", currentUserId, "transactions"));
                    
                    batch.set(transactionRef, { 
                        type, 
                        category, 
                        amount: parseFloat(amount), 
                        date: transactionDate.toISOString().split('T')[0], 
                        comment, 
                        isRecurring: true, 
                        recurringId, 
                        frequency, 
                        instances,
                        isTemplate: isTemplate
                    });
                }
                try {
                    await batch.commit();
                    showMessage(`Successfully added ${instances} recurring transactions!`, "success");
                    transactionForm.reset();
                    document.getElementById('recurringOptions').style.display = 'none';
                    updateCategories();
                } catch (e) {
                    console.error("Error adding recurring transactions: ", e);
                    showMessage("Failed to add recurring transactions. Please try again.", "error");
                }
            } else {
                try {
                    await addDoc(collection(db, "users", currentUserId, "transactions"), { 
                        type, 
                        category, 
                        amount: parseFloat(amount), 
                        date, 
                        comment, 
                        isRecurring: false,
                        isTemplate: isTemplate
                    });
                    showMessage("Transaction added successfully!", "success");
                    transactionForm.reset();
                    updateCategories();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("Failed to add transaction. Please try again.", "error");
                }
            }
        });
        
        function showMessage(text, type = "success") {
            const container = document.getElementById("messageContainer");
            container.innerHTML = `<div id="fadeMessage" style="padding:12px 20px; border-radius:6px; font-weight:500; font-size:1.1rem; background:${type === "success" ? "#e6f9ec" : "#ffeaea"}; color:${type === "success" ? "#198754" : "#dc3545"}; box-shadow:0 2px 8px rgba(0,0,0,0.07); opacity:1; transition:opacity 0.7s;">${text}</div>`;
            setTimeout(() => {
                const msg = document.getElementById("fadeMessage");
                if (msg) msg.style.opacity = "0";
                setTimeout(() => { container.innerHTML = ""; }, 700);
            }, 3000);
        }

        const logoutButton = document.getElementById("logoutButton");
        logoutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            try { await signOut(auth); } 
            catch (error) { console.error("Error signing out: ", error); alert("Failed to log out. Please try again."); }
        });
        
        const scanButton = document.getElementById('scanReceiptBtn');
        const scannerContainer = document.getElementById('scanner-container');
        const video = document.getElementById('video-preview');
        const captureBtn = document.getElementById('captureBtn');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        const canvas = document.getElementById('canvas-capture');
        const loader = document.getElementById('ocr-loader');
        const ocrStatus = document.getElementById('ocr-status');

        const openCamera = async () => {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }
                });
                video.srcObject = videoStream;
                video.play();
                scannerContainer.style.display = 'flex';
            } catch (err) {
                console.error("Error accessing camera:", err);
                showMessage("Could not access camera. Please check permissions.", "error");
            }
        };

        const closeCamera = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            scannerContainer.style.display = 'none';
        };

        const captureImage = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            closeCamera();
            scanImageFromCanvas();
        };

        const scanImageFromCanvas = async () => {
            loader.style.display = 'flex';
            try {
                const { data: { text } } = await Tesseract.recognize(
                    canvas,
                    'eng',
                    {
                        logger: m => {
                           ocrStatus.textContent = `${m.status} (${(m.progress * 100).toFixed(0)}%)`;
                        }
                    }
                );
                extractDataFromText(text);
            } catch (err) {
                console.error("OCR Error:", err);
                showMessage("Failed to scan receipt. Please try again.", "error");
            } finally {
                loader.style.display = 'none';
                ocrStatus.textContent = 'Scanning receipt...';
            }
        };
        
        const extractDataFromText = (text) => {
            console.log("OCR Text:", text);
            const lowerCaseText = text.toLowerCase();
            
            const categoryKeywords = {
                "Transport": ["pickme","uber", "hire", "travel", "uber", "taxi", "bus", "train", "cab", "transport", "rental", "ride", "fare", "ticket"],
                "Food": ["food", "pickme food","uber eats","eat", "restaurant", "cafe", "pizza", "kottu", "meal", "dine", "burger", "coffee", "tea", "breakfast", "lunch", "dinner"],
                "Utilities": ["bill", "electricity", "water", "internet", "dialog", "mobitel", "airtel", "utility", "power", "phone", "broadband", "gas", "gas bill", "electricity bill", "water bill", "internet bill", "dialog bill", "mobitel bill", "airtel bill", "broadband bill", "gas bill", "power bill", "phone bill"],
                "Health": ["pharmacy","chemists", "hospital", "clinic", "doctor", "medicine", "medication", "health", "dental", "optical", "surgery", "wellness", "physiotherapy"],
                "Clothing": ["clothing", "fashion", "nolimit", "odel", "apparel", "shoes", "wear", "garments", "dress", "outfit", "jeans", "t-shirt", "sneakers"],
                "Fuel": ["filling", "station", "petrol", "gasoline", "gas", "diesel", "service", "fuel", "oil"],
                "Entertainment": ["movie", "cinema", "netflix", "spotify", "concert", "game", "theater", "entertainment", "show", "event", "amusement", "recreation"],
                "Household": ["furniture", "appliance", "home", "decor", "ikea", "laundry","keells", "cargills", "glomark", "supermarket", "grocery"],
                "Cash Withdraw": ["atm", "withdraw", "cash", "money", "bank", "transfer", "payment", "withdrawal", "deposit", "transfer", "cheque", "cheque deposit", "cheque withdrawal", "cheque payment", "cheque transfer"],
                "Loans": ["loan", "bank", "finance", "interest","debt", "emi", "mortgage", "credit"],
                "Savings": ["savings", "deposit", "fixed deposit", "recurring deposit", "fd", "rd", "investment"],
                "Salary": ["salary", "payroll", "income", "employer"],
                "Gift": ["gift", "present", "donation", "charity", "donation", "charity", "gift", "present", "donation", "charity", "donation", "charity"],
                "Bonus": ["bonus", "incentive", "reward"],
                "Interest": ["interest", "dividend", "investment", "returns", "dividends"],
                "Business Income": ["business", "freelance", "contract", "client"],
                "Others": ["others", "miscellaneous", "various", "misc", "other" ]
            };

            let foundCategory = null;
            for (const category in categoryKeywords) {
                if (categoryKeywords[category].some(keyword => lowerCaseText.includes(keyword))) {
                    foundCategory = category;
                    break;
                }
            }

            let foundDate = null;
            const dateRegex = new RegExp(
            String.raw`(\d{4}[-/\.]\d{2}[-/\.]\d{2})|(\d{2}[-/\.]\d{2}[-/\.]\d{4})|(\d{2}[-/\.]\d{2}[-/\.]\d{2})|(\d{1,2}[-/\.]\d{1,2})|(\d{1,2}\s+(?:jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*[\s,]*\d{2,4})|((?:jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+\d{1,2},?\s*\d{2,4})`,
            "i"
            );

            const dateMatch = text.match(dateRegex);

            if (dateMatch) {
                let dateStr = dateMatch[0].trim().replace(/\./g, '-').replace(/\//g, '-').replace(/,/g, '');
                let parts, day, month, year;

                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    foundDate = dateStr;

                } else if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                    parts = dateStr.split('-');
                    if (parseInt(parts[0], 10) > 12) {
                        day = parts[0];
                        month = parts[1];
                    } else {
                        day = parts[0];
                        month = parts[1];
                    }
                    year = parts[2];
                    foundDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                } else if (/^\d{2}-\d{2}-\d{2}$/.test(dateStr)) {
                    parts = dateStr.split('-');
                    day = parts[0];
                    month = parts[1];
                    year = parseInt(parts[2], 10);
                    year += year < 50 ? 2000 : 1900;
                    foundDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                } else if (/^\d{1,2}-\d{1,2}$/.test(dateStr)) {
                    parts = dateStr.split('-');
                    day = parts[0];
                    month = parts[1];
                    year = new Date().getFullYear();
                    foundDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                } else {
                    const monthMap = {
                        jan: "01", feb: "02", mar: "03", apr: "04", may: "05", jun: "06",
                        jul: "07", aug: "08", sep: "09", sept: "09", oct: "10", nov: "11", dec: "12"
                    };

                    const textDateRegex = /(\d{1,2})\s+([a-z]+)\s+(\d{2,4})/i;
                    const textDateAltRegex = /([a-z]+)\s+(\d{1,2})\s+(\d{2,4})/i;

                    let match1 = dateStr.match(textDateRegex);
                    let match2 = dateStr.match(textDateAltRegex);

                    if (match1) {
                        day = match1[1];
                        month = monthMap[match1[2].substring(0,3).toLowerCase()] || "01";
                        year = match1[3].length === 2 ? 
                            (parseInt(match1[3],10) < 50 ? 2000+parseInt(match1[3],10) : 1900+parseInt(match1[3],10)) 
                            : match1[3];
                        foundDate = `${year}-${month}-${day.padStart(2, '0')}`;
                    } else if (match2) {
                        month = monthMap[match2[1].substring(0,3).toLowerCase()] || "01";
                        day = match2[2];
                        year = match2[3].length === 2 ? 
                            (parseInt(match2[3],10) < 50 ? 2000+parseInt(match2[3],10) : 1900+parseInt(match2[3],10)) 
                            : match2[3];
                        foundDate = `${year}-${month}-${day.padStart(2, '0')}`;
                    }
                }
            }
            let foundAmount = 0;

            const amountRegex = new RegExp(
                String.raw`(?:total|net|amount|balance|subtotal|grand\s*total|payable|cash\s*amount|bill\s*amount|rs\.?|lkr|inr|usd|eur|gbp|jpy|rm|aed)[\s:]*[\-]?\s*(?:[₹$€£¥]?\s*)?([\d]{1,3}(?:[,\s]\d{2,3})*(?:\.\d{1,2})?|\d+(?:\.\d{1,2})?)\b`,
                "ig"
            );

            let amountMatches;
            let maxAmount = 0;

            while ((amountMatches = amountRegex.exec(text)) !== null) {
                const raw = amountMatches[1].replace(/[, ]/g, "");
                const amount = parseFloat(raw);
                if (!isNaN(amount) && amount > maxAmount) {
                    maxAmount = amount;
                }
            }

            if (maxAmount === 0) {
                const genericAmountRegex = /(?:[₹$€£¥]?\s*)?(\d{1,3}(?:[,\s]\d{2,3})*(?:\.\d{1,2})?|\d+(?:\.\d{1,2})?)/g;
                let genericMatches;
                while ((genericMatches = genericAmountRegex.exec(text)) !== null) {
                    const raw = genericMatches[1].replace(/[, ]/g, "");
                    const amount = parseFloat(raw);
                    if (!isNaN(amount) && amount > maxAmount) {
                        maxAmount = amount;
                    }
                }
            }

            if (maxAmount === 0) {
                const numberWordsMap = {
                    zero: 0, one: 1, two: 2, three: 3, four: 4, five: 5,
                    six: 6, seven: 7, eight: 8, nine: 9, ten: 10,
                    eleven: 11, twelve: 12, thirteen: 13, fourteen: 14, fifteen: 15,
                    sixteen: 16, seventeen: 17, eighteen: 18, nineteen: 19,
                    twenty: 20, thirty: 30, forty: 40, fifty: 50, sixty: 60,
                    seventy: 70, eighty: 80, ninety: 90,
                    hundred: 100, thousand: 1000, lakh: 100000, million: 1000000
                };

                const wordsRegex = /\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety|hundred|thousand|lakh|million)\b/ig;
                if (wordsRegex.test(text)) {
                    const words = text.toLowerCase().match(wordsRegex) || [];
                    let total = 0, temp = 0;
                    for (let word of words) {
                        const val = numberWordsMap[word];
                        if (val === 100 && temp > 0) {
                            temp *= 100;
                        } else if ((val === 1000 || val === 100000 || val === 1000000) && temp > 0) {
                            temp *= val;
                            total += temp;
                            temp = 0;
                        } else {
                            temp += val;
                        }
                    }
                    total += temp;
                    if (total > maxAmount) maxAmount = total;
                }
            }

            foundAmount = maxAmount;


            fillFormWithExtractedData(foundCategory, foundDate, foundAmount, text);
        };
        
        const fillFormWithExtractedData = (category, date, amount, rawText) => {
            if (category) {
                const categorySelect = document.getElementById('category');
                const categoryExists = [...categorySelect.options].some(opt => opt.value === category);
                if (categoryExists) {
                    categorySelect.value = category;
                }
            }
            if (date) {
                document.getElementById('date').value = date;
            }
            if (amount > 0) {
                document.getElementById('amount').value = amount.toFixed(2);
            }

            const commentField = document.getElementById('comment');
            commentField.value = `[Scanned Receipt] \n${rawText.substring(0, 100)}...`;

            showMessage("Receipt scanned! Please review the details.", "success");
        };

        scanButton.addEventListener('click', openCamera);
        closeScannerBtn.addEventListener('click', closeCamera);
        captureBtn.addEventListener('click', captureImage);

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

