<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - FinSight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <img src="logo.png" alt="FinSight Logo" class="logo-image">
            <div>
                <a href="input.html" class="btn btn-success me-2">Addd Transaction</a>
                <a href="history.html" class="btn btn-primary me-2">All Transactions</a>
                <button class="btn btn-warning" onclick="exportTransactions()">Export</button>
                <a href="#" class="btn btn-danger" id="logoutButton">Logout</a>
                
            </div>
        </div>

        <form class="row g-3 mb-4">
            <div class="col-md-3">
                <label for="fromDate" class="form-label">From</label>
                <input type="date" class="form-control" id="fromDate" />
            </div>
            <div class="col-md-3">
                <label for="toDate" class="form-label">To</label>
                <input type="date" class="form-control" id="toDate" />
            </div>
            <div class="col-md-3">
                <label for="filterCategory" class="form-label">Category</label>
                <select class="form-select" id="filterCategory">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="amountRange" class="form-label">Amount Range</label>
                <input
                    type="text"
                    class="form-control"
                    id="amountRange"
                    placeholder="min-max"
                    title="Enter amount range like 100-1000"
                />
            </div>
            <div class="col-12 text-end">
                <button type="button" class="btn btn-primary" onclick="filterData()">Apply Filters</button>
            </div>
        </form>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <canvas id="incomeChart" aria-label="Income Chart" role="img"></canvas>
            </div>
            <div class="col-md-6 mb-4">
                <canvas id="expenseChart" aria-label="Expense Chart" role="img"></canvas>
            </div>
        </div>
        
        <div class="row justify-content-center mb-4" id="summaryTable">
            </div>

        <div class="mt-5">
            <h5>Recent Transactions</h5>
            <ul id="recentTransactions" class="list-group"></ul>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl8wXLzjuHGHohU70LOoObJ7OZUhHpWDQ",
            authDomain: "finsight-567f4.firebaseapp.com",
            projectId: "finsight-567f4",
            storageBucket: "finsight-567f4.firebasestorage.app",
            messagingSenderId: "329662315678",
            appId: "1:329662315678:web:735fbacbca2818e0674f8f",
            measurementId: "G-3BYVY6PE64"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        // Data and state variables
        const incomeCategories = [
            "Salary", "Gift", "Bonus", "Interest", "Business Income", "Others"
        ];
        const expenseCategories = [
            "Food", "Transport", "Utilities", "Cash Withdraw", "Health", "Loans", "Clothing",
            "Household", "Savings", "Entertainment", "Others"
        ];

        let transactions = [];
        let deletedTxnData = null;
        let currentUserId = null;
        let incomeChart, expenseChart;
        let unsubscribeFromTransactions = null;

        // Utility functions
        function formatAmount(amount) {
            return parseFloat(amount).toLocaleString("en-US", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            });
        }
        
        function setupRealtimeListener() {
            onAuthStateChanged(auth, (user) => {
                if (unsubscribeFromTransactions) {
                    unsubscribeFromTransactions();
                }

                if (user) {
                    currentUserId = user.uid;
                    const userTransactionsRef = collection(db, "users", currentUserId, "transactions");
                    
                    unsubscribeFromTransactions = onSnapshot(query(userTransactionsRef), (querySnapshot) => {
                        transactions = querySnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        renderDashboard();
                    }, (error) => {
                        console.error("Error listening to user transactions: ", error);
                    });
                } else {
                    currentUserId = null;
                    transactions = [];
                    renderDashboard();
                    window.location.href = "index.html";
                }
            });
        }

        function populateCategoryFilter() {
            const filter = document.getElementById("filterCategory");
            const categories = [
                ...new Set(transactions.map((t) => t.category).filter(Boolean)),
            ];
            filter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach((cat) => {
                const option = document.createElement("option");
                option.value = cat;
                option.textContent = cat;
                filter.appendChild(option);
            });
        }

        function filterTransactions() {
            const fromDate = document.getElementById("fromDate").value;
            const toDate = document.getElementById("toDate").value;
            const filterCategory = document.getElementById("filterCategory").value;
            const amountRangeStr = document.getElementById("amountRange").value.trim();

            let minAmount = null, maxAmount = null;
            if (amountRangeStr) {
                const parts = amountRangeStr.split("-");
                if (parts.length === 2) {
                    minAmount = parseFloat(parts[0]);
                    maxAmount = parseFloat(parts[1]);
                }
            }

            return transactions.filter((t) => {
                if (fromDate && t.date < fromDate) return false;
                if (toDate && t.date > toDate) return false;
                if (filterCategory && t.category !== filterCategory) return false;

                const amount = parseFloat(t.amount);
                if (minAmount !== null && !isNaN(minAmount) && amount < minAmount) return false;
                if (maxAmount !== null && !isNaN(maxAmount) && amount > maxAmount) return false;

                return true;
            });
        }
        
        function renderCharts(filteredTxns) {
            const incomeData = {};
            const expenseData = {};
            filteredTxns.forEach((t) => {
                if (t.type === "Income") {
                    incomeData[t.category] = (incomeData[t.category] || 0) + parseFloat(t.amount);
                } else if (t.type === "Expense") {
                    expenseData[t.category] = (expenseData[t.category] || 0) + parseFloat(t.amount);
                }
            });

            const incomeLabels = Object.keys(incomeData);
            const incomeAmounts = incomeLabels.map((cat) => incomeData[cat]);
            const expenseLabels = Object.keys(expenseData);
            const expenseAmounts = expenseLabels.map((cat) => expenseData[cat]);
            if (incomeChart) incomeChart.destroy();
            if (expenseChart) expenseChart.destroy();
            const incomeCtx = document.getElementById("incomeChart").getContext("2d");
            incomeChart = new Chart(incomeCtx, {
                type: "doughnut",
                data: {
                    labels: incomeLabels,
                    datasets: [{
                        label: "Income",
                        data: incomeAmounts,
                        backgroundColor: incomeLabels.map(() => "#28A745cc"),
                        borderColor: incomeLabels.map(() => "#ffffff"),
                        borderWidth: 1,
                    }],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: "bottom" },
                        title: { display: true, text: "Income Breakdown" },
                    },
                },
            });
            const expenseCtx = document.getElementById("expenseChart").getContext("2d");
            expenseChart = new Chart(expenseCtx, {
                type: "doughnut",
                data: {
                    labels: expenseLabels,
                    datasets: [{
                        label: "Expense",
                        data: expenseAmounts,
                        backgroundColor: expenseLabels.map(() => "#cc0000cc"),
                        borderColor: expenseLabels.map(() => "#ffffff"),
                        borderWidth: 1,
                    }],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: "bottom" },
                        title: { display: true, text: "Expense Breakdown" },
                    },
                },
            });
        }
        
        function renderSummaryTable(filteredTxns) {
            const summaryDiv = document.getElementById("summaryTable");
            let totalIncome = 0;
            let totalExpense = 0;
            filteredTxns.forEach((t) => {
                if (t.type === "Income") totalIncome += parseFloat(t.amount);
                else if (t.type === "Expense") totalExpense += parseFloat(t.amount);
            });
            const balance = totalIncome - totalExpense;

            summaryDiv.innerHTML = `
                <div class="col-md-4 mb-3">
                    <div class="summary-card">
                        <h5>Total Income</h5>
                        <p class="h4 text-success">Rs.${formatAmount(totalIncome)}</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="summary-card">
                        <h5>Total Expense</h5>
                        <p class="h4 text-danger">Rs.${formatAmount(totalExpense)}</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="summary-card">
                        <h5>Balance</h5>
                        <p class="h4 ${balance >= 0 ? 'text-success' : 'text-danger'}">Rs.${formatAmount(balance)}</p>
                    </div>
                </div>
            `;
        }
        
        function renderRecentTransactions() {
            const recentUl = document.getElementById("recentTransactions");
            recentUl.innerHTML = "";
            const sorted = [...transactions].sort((a, b) => b.date.localeCompare(a.date));
            const recent = sorted.slice(0, 10);
            recent.forEach((t) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center " +
                    (t.type === "Income" ? "income-row" : "expense-row");
                li.innerHTML = `
                    <div>
                        <strong>${t.type}</strong> - ${t.category} <br />
                        <small>${t.date}</small><br />
                        <small>${t.comment || ""}</small>
                    </div>
                    <span>Rs.${formatAmount(t.amount)}</span>
                `;
                recentUl.appendChild(li);
            });
        }

        function renderDashboard() {
            const filtered = filterTransactions();
            populateCategoryFilter();
            renderCharts(filtered);
            renderSummaryTable(filtered);
            renderRecentTransactions();
        }

        function showUndoToast() {
            const undoToast = document.getElementById("undoToast");
            if (undoToast) {
                undoToast.style.display = "block";
                setTimeout(() => {
                    undoToast.style.display = "none";
                    deletedTxnData = null;
                }, 5000);
            }
        }
        
        async function deleteTxn(docId) {
            if (!currentUserId) {
                alert("You must be logged in to delete transactions.");
                return;
            }
            if (confirm("Are you sure you want to delete this transaction?")) {
                try {
                    const txnToDelete = transactions.find(t => t.id === docId);
                    if (txnToDelete) {
                        deletedTxnData = { ...txnToDelete };
                    }
                    await deleteDoc(doc(db, "users", currentUserId, "transactions", docId));
                    showUndoToast();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert("Failed to delete transaction. Please try again.");
                }
            }
        }
        
        async function undoDelete() {
            if (deletedTxnData && currentUserId) {
                try {
                    const { id, ...txnDataWithoutId } = deletedTxnData;
                    await addDoc(collection(db, "users", currentUserId, "transactions"), txnDataWithoutId);
                    document.getElementById("undoToast").style.display = "none";
                    deletedTxnData = null;
                    alert("Transaction restored successfully.");
                } catch (e) {
                    console.error("Error restoring transaction: ", e);
                    alert("Failed to restore transaction. Please try again.");
                }
            }
        }
        
        function exportTransactions() {
            if (!transactions.length) {
                alert("No transactions to export.");
                return;
            }
            let csv = "Type,Category,Amount,Date,Comment\n";
            transactions.forEach((t) => {
                const comment = t.comment ? `"${t.comment.replace(/"/g, '""')}"` : "";
                csv += `${t.type},${t.category},${t.amount},${t.date},${comment}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "transactions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function filterData() {
            const filtered = filterTransactions();
            renderCharts(filtered);
            renderSummaryTable(filtered);
            renderRecentTransactions();
        }

        const logout = async () => {
            try {
                if (unsubscribeFromTransactions) {
                    unsubscribeFromTransactions();
                }
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
                alert("Failed to log out. Please try again.");
            }
        };

        window.onload = () => {
            setupRealtimeListener();

            const logoutButton = document.getElementById("logoutButton");
            if (logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }
        };

        window.filterData = filterData;
        window.exportTransactions = exportTransactions;
        window.deleteTxn = deleteTxn;
        window.undoDelete = undoDelete;
    </script>
</body>
</html>