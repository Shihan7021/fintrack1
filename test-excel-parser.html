<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Excel Parser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Excel Parser</h5>
                    </div>
                    <div class="card-body">
                        <input type="file" id="testFile" accept=".xlsx,.xls" class="form-control mb-3">
                        <button onclick="testParse()" class="btn btn-primary">Test Parse</button>
                        <div id="results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Copy the fixed parseExcel function for testing
        function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Use header: 1 to get raw data, then process headers properly
                        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                        
                        if (rawData.length < 2) {
                            return resolve([]);
                        }

                        // Find the first row with actual headers (skip empty rows)
                        let headerRowIndex = 0;
                        for (let i = 0; i < rawData.length; i++) {
                            const row = rawData[i];
                            if (row && row.some(cell => cell && cell.toString().trim())) {
                                headerRowIndex = i;
                                break;
                            }
                        }

                        const headers = rawData[headerRowIndex].map(h => h ? String(h).trim() : "");
                        
                        // Convert data rows to objects using proper headers
                        const dataRows = rawData.slice(headerRowIndex + 1);
                        const transactions = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                if (header && header !== "") {
                                    obj[header] = row[index] !== undefined ? row[index] : "";
                                }
                            });
                            return obj;
                        });

                        // Filter out empty rows
                        const validTransactions = transactions.filter(row => {
                            return Object.values(row).some(value => 
                                value !== "" && value != null && value !== 0
                            );
                        });

                        console.log("Parsed Excel transactions:", validTransactions);
                        resolve(validTransactions);

                    } catch (error) {
                        console.error("Excel parsing error:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Error reading file'));
                reader.readAsArrayBuffer(file);
            });
        }

        function findColumnValue(row, possibleNames) {
            if (!row) return null;
            
            // Normalize keys for comparison
            const normalizedRow = {};
            Object.keys(row).forEach(key => {
                if (key) {
                    normalizedRow[key.toString().trim().toLowerCase()] = row[key];
                }
            });

            // Check each possible name
            for (const name of possibleNames) {
                const normalizedName = name.toString().trim().toLowerCase();
                if (normalizedRow[normalizedName] !== undefined) {
                    return normalizedRow[normalizedName];
                }
            }
            
            // Also check for partial matches
            for (const name of possibleNames) {
                const normalizedName = name.toString().trim().toLowerCase();
                for (const key of Object.keys(normalizedRow)) {
                    if (key.includes(normalizedName) || normalizedName.includes(key)) {
                        return normalizedRow[key];
                    }
                }
            }
            
            return null;
        }

        async function testParse() {
            const fileInput = document.getElementById('testFile');
            const resultsDiv = document.getElementById('results');
            
            if (!fileInput.files.length) {
                alert('Please select a file');
                return;
            }

            try {
                const transactions = await parseExcel(fileInput.files[0]);
                
                let html = `<h6>Found ${transactions.length} transactions:</h6>`;
                html += '<div class="table-responsive"><table class="table table-sm">';
                html += '<thead><tr><th>Date</th><th>Description</th><th>Amount</th></tr></thead><tbody>';
                
                transactions.slice(0, 5).forEach(t => {
                    const date = findColumnValue(t, ['date', 'Date', 'Transaction Date']);
                    const desc = findColumnValue(t, ['description', 'Description', 'Details']);
                    const amount = findColumnValue(t, ['amount', 'Amount', 'Debit', 'Credit']);
                    
                    html += `<tr>
                        <td>${date || 'N/A'}</td>
                        <td>${desc || 'N/A'}</td>
                        <td>${amount || 'N/A'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                if (transactions.length > 5) {
                    html += `<small>... and ${transactions.length - 5} more</small>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
