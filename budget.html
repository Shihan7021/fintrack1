<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Budget - FinSight</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .profile-nav .nav-link {
            color: #495057;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .profile-nav .nav-link.active {
            color: #fff;
            background-color: #3C0775;
        }
        .profile-nav .nav-link:hover {
            background-color: #e9ecef;
        }
        .card {
            border: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .form-label {
            font-weight: 600;
        }
        .btn-primary {
            background-color: #3C0775;
            border-color: #3C0775;
        }
        .btn-primary:hover {
            background-color: #7454AC;
            border-color: #7454AC;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="logo-head.png" alt="FinSight Logo" class="logo-header">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="input.html"><i class="fas fa-plus-circle"></i> Add Transaction</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html"><i class="fas fa-list"></i> All Transactions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="budget.html"><i class="fas fa-chart-pie"></i> Budget</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="myprofile.html"><i class="fas fa-user"></i> My Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-3">
                <div class="card profile-nav">
                    <div class="card-body">
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <a class="nav-link active" id="v-pills-create-budget-tab" data-bs-toggle="pill" href="#v-pills-create-budget" role="tab" aria-controls="v-pills-create-budget" aria-selected="true">
                                <i class="fas fa-plus-circle me-2"></i>Create New Budget
                            </a>
                            <a class="nav-link" id="v-pills-view-budget-tab" data-bs-toggle="pill" href="#v-pills-view-budget" role="tab" aria-controls="v-pills-view-budget" aria-selected="false">
                                <i class="fas fa-edit me-2"></i>View/Edit Budget
                            </a>
                            <a class="nav-link" id="v-pills-analyze-budget-tab" data-bs-toggle="pill" href="#v-pills-analyze-budget" role="tab" aria-controls="v-pills-analyze-budget" aria-selected="false">
                                <i class="fas fa-chart-line me-2"></i>Analyze
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-create-budget" role="tabpanel" aria-labelledby="v-pills-create-budget-tab">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Create New Budget</h4>
                                <!-- Add form fields for creating a new budget -->
                                <form id="createBudgetForm">
                                    <div class="mb-3">
                                        <label for="budgetName" class="form-label">Budget Name</label>
                                        <input type="text" class="form-control" id="budgetName" placeholder="e.g., Monthly Groceries">
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetAmount" class="form-label">Budget Amount</label>
                                        <input type="number" class="form-control" id="budgetAmount" placeholder="e.g., 50000">
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetCategory" class="form-label">Category</label>
                                        <select class="form-select" id="budgetCategory">
                                            <!-- Categories will be populated from Firestore -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetFromDate" class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="budgetFromDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetToDate" class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="budgetToDate" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Create Budget</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-view-budget" role="tabpanel" aria-labelledby="v-pills-view-budget-tab">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">View/Edit Budget</h4>
                                <!-- Display existing budgets here -->
                                <div id="budgetList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-analyze-budget" role="tabpanel" aria-labelledby="v-pills-analyze-budget-tab">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Analyze Budget</h4>
                                <!-- Add budget analysis tools here -->
                                <p>Budget analysis will be available in a future update.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Budget Modal -->
    <div class="modal fade" id="editBudgetModal" tabindex="-1" aria-labelledby="editBudgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBudgetModalLabel">Edit Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBudgetForm">
                        <input type="hidden" id="editBudgetId">
                        <div class="mb-3">
                            <label for="editBudgetName" class="form-label">Budget Name</label>
                            <input type="text" class="form-control" id="editBudgetName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetAmount" class="form-label">Budget Amount</label>
                            <input type="number" class="form-control" id="editBudgetAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetCategory" class="form-label">Category</label>
                            <select class="form-select" id="editBudgetCategory" required>
                                <!-- Categories will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetFromDate" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="editBudgetFromDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetToDate" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="editBudgetToDate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { auth, db } from "./firebase-config.js";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in.
                loadBudgetData(user);
            } else {
                // User is signed out.
                window.location.href = 'index.html';
            }
        });

        async function loadBudgetData(user) {
            // Load categories for budget creation
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const expenseCategories = userData.selectedExpenseCategories || [];
                const customExpenseCategories = userData.customExpenseCategories || [];
                const allExpenseCategories = [...new Set([...expenseCategories, ...customExpenseCategories])];
                
                const budgetCategorySelect = document.getElementById('budgetCategory');
                budgetCategorySelect.innerHTML = '<option value="">Select Category</option>';
                allExpenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    budgetCategorySelect.appendChild(option);
                });
            }

            // Load existing budgets
            const budgetList = document.getElementById('budgetList');
            const budgetsCol = collection(db, "users", user.uid, "budgets");
            const budgetSnapshot = await getDocs(budgetsCol);
            budgetList.innerHTML = ''; // Clear list
            budgetSnapshot.forEach(doc => {
                const budget = doc.data();
                const budgetId = doc.id; // Get the document ID for editing/deleting
                const budgetEl = document.createElement('div');
                budgetEl.classList.add('card', 'mb-3');
                budgetEl.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${budget.name}</h5>
                        <p class="card-text">Amount: ${budget.amount}</p>
                        <p class="card-text">Category: ${budget.category}</p>
                        <p class="card-text">Period: ${budget.fromDate} to ${budget.toDate}</p>
                        <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editBudgetModal" data-budget-id="${budgetId}">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBudget('${budgetId}')">Delete</button>
                    </div>
                `;
                budgetList.appendChild(budgetEl);
            });
        }

        const createBudgetForm = document.getElementById('createBudgetForm');
        createBudgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (user) {
                const budgetName = document.getElementById('budgetName').value;
                const budgetAmount = document.getElementById('budgetAmount').value;
                const budgetCategory = document.getElementById('budgetCategory').value;
                const budgetFromDate = document.getElementById('budgetFromDate').value;
                const budgetToDate = document.getElementById('budgetToDate').value;

                if (budgetName && budgetAmount && budgetCategory && budgetFromDate && budgetToDate) {
                    try {
                        await addDoc(collection(db, "users", user.uid, "budgets"), {
                            name: budgetName,
                            amount: Number(budgetAmount),
                            category: budgetCategory,
                            fromDate: budgetFromDate,
                            toDate: budgetToDate,
                            createdAt: new Date().toISOString()
                        });
                        alert('Budget created successfully!');
                        createBudgetForm.reset();
                        loadBudgetData(user); // Refresh budget list
                    } catch (error) {
                        console.error("Error creating budget:", error);
                        alert('Error creating budget. Please try again.');
                    }
                } else {
                    alert('Please fill out all fields.');
                }
            }
        });

        // Function to populate the edit modal when opened
        document.getElementById('editBudgetModal').addEventListener('show.bs.modal', async (event) => {
            const button = event.relatedTarget; // Button that triggered the modal
            const budgetId = button.getAttribute('data-budget-id'); // Extract info from data-* attributes

            const user = auth.currentUser;
            if (!user) {
                alert("You must be logged in to edit budgets.");
                return;
            }

            try {
                const budgetDocRef = doc(db, "users", user.uid, "budgets", budgetId);
                const budgetDoc = await getDoc(budgetDocRef);

                if (budgetDoc.exists()) {
                    const budgetData = budgetDoc.data();
                    document.getElementById('editBudgetId').value = budgetId;
                    document.getElementById('editBudgetName').value = budgetData.name;
                    document.getElementById('editBudgetAmount').value = budgetData.amount;
                    document.getElementById('editBudgetFromDate').value = budgetData.fromDate;
                    document.getElementById('editBudgetToDate').value = budgetData.toDate;

                    // Populate categories for edit modal
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const expenseCategories = userData.selectedExpenseCategories || [];
                        const customExpenseCategories = userData.customExpenseCategories || [];
                        const allExpenseCategories = [...new Set([...expenseCategories, ...customExpenseCategories])];
                        
                        const editBudgetCategorySelect = document.getElementById('editBudgetCategory');
                        editBudgetCategorySelect.innerHTML = ''; // Clear previous options
                        allExpenseCategories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            if (category === budgetData.category) {
                                option.selected = true;
                            }
                            editBudgetCategorySelect.appendChild(option);
                        });
                    }
                } else {
                    alert("Budget not found.");
                }
            } catch (error) {
                console.error("Error loading budget for edit:", error);
                alert("Error loading budget for edit. Please try again.");
            }
        });

        // Event listener for saving changes from the edit modal
        const editBudgetForm = document.getElementById('editBudgetForm');
        editBudgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("You must be logged in to save changes.");
                return;
            }

            const budgetId = document.getElementById('editBudgetId').value;
            const budgetName = document.getElementById('editBudgetName').value;
            const budgetAmount = document.getElementById('editBudgetAmount').value;
            const budgetCategory = document.getElementById('editBudgetCategory').value;
            const budgetFromDate = document.getElementById('editBudgetFromDate').value;
            const budgetToDate = document.getElementById('editBudgetToDate').value;

            if (budgetName && budgetAmount && budgetCategory && budgetFromDate && budgetToDate) {
                try {
                    const budgetDocRef = doc(db, "users", user.uid, "budgets", budgetId);
                    await setDoc(budgetDocRef, {
                        name: budgetName,
                        amount: Number(budgetAmount),
                        category: budgetCategory,
                        fromDate: budgetFromDate,
                        toDate: budgetToDate,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    alert('Budget updated successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editBudgetModal'));
                    modal.hide();
                    loadBudgetData(user); // Refresh budget list
                } catch (error) {
                    console.error("Error updating budget:", error);
                    alert('Error updating budget. Please try again.');
                }
            }
        });

        window.deleteBudget = async function(budgetId) {
            const user = auth.currentUser;
            if (!user) {
                alert("You must be logged in to delete budgets.");
                return;
            }

            if (confirm("Are you sure you want to delete this budget? This action cannot be undone.")) {
                try {
                    const budgetDocRef = doc(db, "users", user.uid, "budgets", budgetId);
                    await deleteDoc(budgetDocRef);
                    alert('Budget deleted successfully!');
                    loadBudgetData(user); // Refresh budget list
                } catch (error) {
                    console.error("Error deleting budget:", error);
                    alert('Error deleting budget. Please try again.');
                }
            }
        };

        const logoutButton = document.getElementById('logoutButton');
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });
    </script>
</body>
</html>