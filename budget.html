<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Budget - FinSight</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .profile-nav .nav-link {
            color: #495057;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .profile-nav .nav-link.active {
            color: #fff;
            background-color: #3C0775;
        }
        .profile-nav .nav-link:hover {
            background-color: #e9ecef;
        }
        .card {
            border: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .form-label {
            font-weight: 600;
        }
        .btn-primary {
            background-color: #3C0775;
            border-color: #3C0775;
        }
        .btn-primary:hover {
            background-color: #7454AC;
            border-color: #7454AC;
        }
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="logo-head.png" alt="FinSight Logo" class="logo-header">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="input.html"><i class="fas fa-plus-circle"></i> Add Transaction</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html"><i class="fas fa-list"></i> All Transactions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="budget.html"><i class="fas fa-chart-pie"></i> Budget</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="myprofile.html"><i class="fas fa-user"></i> My Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-3">
                <div class="card profile-nav">
                    <div class="card-body">
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <a class="nav-link active" id="v-pills-create-budget-tab" data-bs-toggle="pill" href="#v-pills-create-budget" role="tab" aria-controls="v-pills-create-budget" aria-selected="true">
                                <i class="fas fa-plus-circle me-2"></i>Create New Budget
                            </a>
                            <a class="nav-link" id="v-pills-view-budget-tab" data-bs-toggle="pill" href="#v-pills-view-budget" role="tab" aria-controls="v-pills-view-budget" aria-selected="false">
                                <i class="fas fa-edit me-2"></i>View/Edit Budget
                            </a>
                            <a class="nav-link" id="v-pills-analyze-budget-tab" data-bs-toggle="pill" href="#v-pills-analyze-budget" role="tab" aria-controls="v-pills-analyze-budget" aria-selected="false">
                                <i class="fas fa-chart-line me-2"></i>Analyze
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-create-budget" role="tabpanel" aria-labelledby="v-pills-create-budget-tab">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Create New Budget</h4>
                                <form id="createBudgetForm">
                                    <div class="mb-3">
                                        <label for="budgetName" class="form-label">Budget Name</label>
                                        <input type="text" class="form-control" id="budgetName" placeholder="e.g., Monthly Groceries">
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetAmount" class="form-label">Budget Amount</label>
                                        <input type="number" class="form-control" id="budgetAmount" placeholder="e.g., 50000">
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetCategory" class="form-label">Category</label>
                                        <select class="form-select" id="budgetCategory">
                                            </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetFromDate" class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="budgetFromDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="budgetToDate" class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="budgetToDate" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Create Budget</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-view-budget" role="tabpanel" aria-labelledby="v-pills-view-budget-tab">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">View/Edit Budget</h4>
                                <div id="budgetList">
                                    <p class="text-muted">Loading budgets...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-analyze-budget" role="tabpanel" aria-labelledby="v-pills-analyze-budget-tab">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Analyze Budget</h4>
                                <div id="budgetAnalysisResults">
                                    <p class="text-muted">Loading budget analysis...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editBudgetModal" tabindex="-1" aria-labelledby="editBudgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBudgetModalLabel">Edit Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBudgetForm">
                        <input type="hidden" id="editBudgetId">
                        <div class="mb-3">
                            <label for="editBudgetName" class="form-label">Budget Name</label>
                            <input type="text" class="form-control" id="editBudgetName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetAmount" class="form-label">Budget Amount</label>
                            <input type="number" class="form-control" id="editBudgetAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetCategory" class="form-label">Category</label>
                            <select class="form-select" id="editBudgetCategory" required>
                                </select>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetFromDate" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="editBudgetFromDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBudgetToDate" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="editBudgetToDate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { auth, db } from "./firebase-config.js";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadBudgetData(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        function formatAmount(amount) {
            return parseFloat(amount).toLocaleString("en-US", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            });
        }

        async function loadBudgetData(user) {
            // Load categories for budget creation form
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const expenseCategories = userData.selectedExpenseCategories || [];
                const customExpenseCategories = userData.customExpenseCategories || [];
                const allExpenseCategories = [...new Set([...expenseCategories, ...customExpenseCategories])];
                
                const budgetCategorySelect = document.getElementById('budgetCategory');
                budgetCategorySelect.innerHTML = '<option value="">Select Category</option>';
                allExpenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    budgetCategorySelect.appendChild(option);
                });
            }

            // Fetch all expense transactions for the user ONCE for efficiency
            const transactionsCol = collection(db, "users", user.uid, "transactions");
            const q = query(transactionsCol, where("type", "==", "expense"));
            const transactionSnapshot = await getDocs(q);
            const allExpenses = [];
            transactionSnapshot.forEach(doc => {
                allExpenses.push(doc.data());
            });

            // Load existing budgets and calculate their progress
            const budgetList = document.getElementById('budgetList');
            const budgetsCol = collection(db, "users", user.uid, "budgets");
            const budgetSnapshot = await getDocs(budgetsCol);
            budgetList.innerHTML = ''; // Clear list

            if (budgetSnapshot.empty) {
                budgetList.innerHTML = '<p class="text-muted">No budgets have been created yet.</p>';
                return;
            }

            budgetSnapshot.forEach(doc => {
                const budget = doc.data();
                const budgetId = doc.id;

                // Filter transactions that fall within this budget's category and date range
                const relevantExpenses = allExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const budgetFromDate = new Date(budget.fromDate);
                    const budgetToDateObj = new Date(budget.toDate);
                    budgetToDateObj.setDate(budgetToDateObj.getDate() + 1); // Go to the next day
                    
                    return expense.category === budget.category &&
                           expenseDate >= budgetFromDate &&
                           expenseDate < budgetToDateObj; // Strictly less than the start of the next day
                });

                // Calculate the total amount spent
                const totalSpent = relevantExpenses.reduce((sum, expense) => sum + Number(expense.amount), 0);
                const budgetAmount = Number(budget.amount);
                
                // Calculate progress percentage
                let progressPercentage = budgetAmount > 0 ? (totalSpent / budgetAmount) * 100 : 0;

                // Determine progress bar color
                let progressBarClass = 'bg-success';
                if (progressPercentage > 100) {
                    progressBarClass = 'bg-danger';
                } else if (progressPercentage >= 80) {
                    progressBarClass = 'bg-warning';
                }

                // The visual bar shouldn't exceed 100%
                const visualProgressPercentage = Math.min(progressPercentage, 100);

                // Create the budget card element
                const budgetEl = document.createElement('div');
                budgetEl.classList.add('card', 'mb-3');
                budgetEl.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="card-title mb-0">${budget.name}</h5>
                                <span class="badge bg-secondary">${budget.category}</span>
                                <p class="card-text text-muted small mt-1">Period: ${budget.fromDate} to ${budget.toDate}</p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#editBudgetModal" data-budget-id="${budgetId}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBudget('${budgetId}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        
                        <div class="mb-1 d-flex justify-content-between">
                            <span class="fw-bold">Spent: ${formatAmount(totalSpent)}</span>
                            <span>Budget: ${formatAmount(budgetAmount)}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar ${progressBarClass}" role="progressbar" 
                                 style="width: ${visualProgressPercentage}%;" 
                                 aria-valuenow="${visualProgressPercentage}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                 ${visualProgressPercentage.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
                budgetList.appendChild(budgetEl);
            });
        }

        const createBudgetForm = document.getElementById('createBudgetForm');
        createBudgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (user) {
                const budgetName = document.getElementById('budgetName').value;
                const budgetAmount = document.getElementById('budgetAmount').value;
                const budgetCategory = document.getElementById('budgetCategory').value;
                const budgetFromDate = document.getElementById('budgetFromDate').value;
                const budgetToDate = document.getElementById('budgetToDate').value;

                if (budgetName && budgetAmount && budgetCategory && budgetFromDate && budgetToDate) {
                    try {
                        await addDoc(collection(db, "users", user.uid, "budgets"), {
                            name: budgetName,
                            amount: Number(budgetAmount),
                            category: budgetCategory,
                            fromDate: budgetFromDate,
                            toDate: budgetToDate,
                            createdAt: new Date().toISOString()
                        });
                        alert('Budget created successfully!');
                        createBudgetForm.reset();
                        loadBudgetData(user);
                    } catch (error) {
                        console.error("Error creating budget:", error);
                        alert('Error creating budget. Please try again.');
                    }
                } else {
                    alert('Please fill out all fields.');
                }
            }
        });

        document.getElementById('editBudgetModal').addEventListener('show.bs.modal', async (event) => {
            const button = event.relatedTarget;
            const budgetId = button.getAttribute('data-budget-id');
            const user = auth.currentUser;
            if (!user) return;

            try {
                const budgetDocRef = doc(db, "users", user.uid, "budgets", budgetId);
                const budgetDoc = await getDoc(budgetDocRef);

                if (budgetDoc.exists()) {
                    const budgetData = budgetDoc.data();
                    document.getElementById('editBudgetId').value = budgetId;
                    document.getElementById('editBudgetName').value = budgetData.name;
                    document.getElementById('editBudgetAmount').value = budgetData.amount;
                    document.getElementById('editBudgetFromDate').value = budgetData.fromDate;
                    document.getElementById('editBudgetToDate').value = budgetData.toDate;

                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const expenseCategories = userData.selectedExpenseCategories || [];
                        const customExpenseCategories = userData.customExpenseCategories || [];
                        const allExpenseCategories = [...new Set([...expenseCategories, ...customExpenseCategories])];
                        
                        const editBudgetCategorySelect = document.getElementById('editBudgetCategory');
                        editBudgetCategorySelect.innerHTML = '';
                        allExpenseCategories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            if (category === budgetData.category) {
                                option.selected = true;
                            }
                            editBudgetCategorySelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error("Error loading budget for edit:", error);
            }
        });

        const editBudgetForm = document.getElementById('editBudgetForm');
        editBudgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const budgetId = document.getElementById('editBudgetId').value;
            const budgetName = document.getElementById('editBudgetName').value;
            const budgetAmount = document.getElementById('editBudgetAmount').value;
            const budgetCategory = document.getElementById('editBudgetCategory').value;
            const budgetFromDate = document.getElementById('editBudgetFromDate').value;
            const budgetToDate = document.getElementById('editBudgetToDate').value;

            if (budgetName && budgetAmount && budgetCategory && budgetFromDate && budgetToDate) {
                try {
                    const budgetDocRef = doc(db, "users", user.uid, "budgets", budgetId);
                    await setDoc(budgetDocRef, {
                        name: budgetName,
                        amount: Number(budgetAmount),
                        category: budgetCategory,
                        fromDate: budgetFromDate,
                        toDate: budgetToDate,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    alert('Budget updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editBudgetModal')).hide();
                    loadBudgetData(user);
                } catch (error) {
                    console.error("Error updating budget:", error);
                    alert('Error updating budget. Please try again.');
                }
            }
        });

        window.deleteBudget = async function(budgetId) {
            const user = auth.currentUser;
            if (!user) return;

            if (confirm("Are you sure you want to delete this budget?")) {
                try {
                    await deleteDoc(doc(db, "users", user.uid, "budgets", budgetId));
                    alert('Budget deleted successfully!');
                    loadBudgetData(user);
                } catch (error) {
                    console.error("Error deleting budget:", error);
                    alert('Error deleting budget. Please try again.');
                }
            }
        };

        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });
    </script>
</body>
</html>