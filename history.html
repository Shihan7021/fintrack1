<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transaction History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <!-- Header Menu Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <!-- Logo and Brand -->
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="logo-head.png" alt="FinSight Logo" class="logo-header">
            </a>
            
            <!-- Mobile Toggle Button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Menu Items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="input.html">
                            <i class="fas fa-plus-circle"></i> Add Transaction
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="history.html">
                            <i class="fas fa-list"></i> All Transactions
                        </a>
                    </li>
                </ul>
                
                <!-- Right Side Menu -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="myprofile.html">
                            <i class="fas fa-user"></i> Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="exportTransactions()">
                            <i class="fas fa-download"></i> Export
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutButton">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="header-container">
            <h2>Transaction History</h2>
        </div>

        <ul class="nav nav-tabs" id="historyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-transactions-tab" data-bs-toggle="tab" data-bs-target="#all-transactions" type="button" role="tab" aria-controls="all-transactions" aria-selected="true">All Transactions</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recurring-transactions-tab" data-bs-toggle="tab" data-bs-target="#recurring-transactions" type="button" role="tab" aria-controls="recurring-transactions" aria-selected="false">Recurring Transactions</button>
            </li>
        </ul>

        <div class="tab-content" id="historyTabsContent">
            <div class="tab-pane fade show active" id="all-transactions" role="tabpanel" aria-labelledby="all-transactions-tab">
                <div class="row mb-3 g-3 mt-2">
                    <div class="col-md-4">
                        <label for="filterCategory" class="form-label">Category</label>
                        <select id="filterCategory" class="form-select" onchange="renderHistory()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filterType" class="form-label">Type</label>
                        <select id="filterType" class="form-select" onchange="renderHistory()">
                            <option value="">All</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="amountRange" class="form-label">Amount Range</label>
                        <input
                            type="text"
                            id="amountRange"
                            class="form-control"
                            placeholder="min-max"
                            onchange="renderHistory()"
                            title="Enter amount range like 100-1000"
                        />
                    </div>
                </div>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Comment</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
                
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-danger" onclick="deleteAllFilteredTransactions()">
                        <i class="fas fa-trash-alt"></i> Delete All
                    </button>
                </div>
            </div>
            <div class="tab-pane fade" id="recurring-transactions" role="tabpanel" aria-labelledby="recurring-transactions-tab">
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th>Instances</th>
                            <th>Start Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recurringHistoryTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, deleteDoc, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAl8wXLzjuHGHohU70LOoObJ7OZUhHpWDQ",
            authDomain: "finsight-567f4.firebaseapp.com",
            projectId: "finsight-567f4",
            storageBucket: "finsight-567f4.firebasestorage.app",
            messagingSenderId: "329662315678",
            appId: "1:329662315678:web:735fbacbca2818e0674f8f",
            measurementId: "G-3BYVY6PE64"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;

        let txns = [];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                const userTransactionsCollection = collection(db, "users", currentUserId, "transactions");
                
                onSnapshot(query(userTransactionsCollection), (querySnapshot) => {
                    txns = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderCategoryFilter();
                    renderHistory();
                    renderRecurringHistory();
                }, (error) => {
                    console.error("Error listening to user transactions: ", error);
                    alert("Failed to load your transactions. Please try again.");
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function renderCategoryFilter() {
            const filter = document.getElementById("filterCategory");
            const categories = [...new Set(txns.map(t => t.category))];
            filter.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function formatAmount(amount) {
            return parseFloat(amount).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderHistory() {
            const category = document.getElementById("filterCategory").value;
            const type = document.getElementById("filterType").value;
            const range = document.getElementById("amountRange").value.split("-").map(x => parseFloat(x));
            const tbody = document.getElementById("historyTableBody");
            tbody.innerHTML = "";

            txns.forEach((t) => {
                const inCategory = !category || t.category === category;
                const inType = !type || t.type === type;
                const amount = parseFloat(t.amount);
                const inRange =
                    (isNaN(range[0]) && isNaN(range[1])) ||
                    ((!isNaN(range[0]) && amount >= range[0]) && (!isNaN(range[1]) && amount <= range[1]));

                if (inCategory && inType && inRange) {
                    const row = document.createElement("tr");
                    row.className = t.type === "Income" ? "income-row" : "expense-row";
                    row.innerHTML = `
                        <td>${t.type}</td>
                        <td>${t.category}</td>
                        <td>Rs.${formatAmount(t.amount)}</td>
                        <td>${t.date}</td>
                        <td>${t.comment || ""}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteTxn('${t.id}')">Delete</button></td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function renderRecurringHistory() {
            const recurringTxns = txns.filter(t => t.isRecurring);
            const recurringSeries = {};

            recurringTxns.forEach(t => {
                if (!recurringSeries[t.recurringId]) {
                    recurringSeries[t.recurringId] = [];
                }
                recurringSeries[t.recurringId].push(t);
            });

            const tbody = document.getElementById("recurringHistoryTableBody");
            tbody.innerHTML = "";

            for (const recurringId in recurringSeries) {
                const series = recurringSeries[recurringId];
                const firstTxn = series.sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${firstTxn.type}</td>
                    <td>${firstTxn.category}</td>
                    <td>Rs.${formatAmount(firstTxn.amount)}</td>
                    <td>${firstTxn.frequency}</td>
                    <td>${firstTxn.instances}</td>
                    <td>${firstTxn.date}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" disabled>Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecurringSeries('${recurringId}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        async function deleteTxn(docId) {
            if (!currentUserId) {
                alert("You must be logged in to delete transactions.");
                return;
            }
            if (confirm("Are you sure you want to delete this transaction?")) {
                try {
                    await deleteDoc(doc(db, "users", currentUserId, "transactions", docId));
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert("Failed to delete transaction. Please try again.");
                }
            }
        }

        async function deleteRecurringSeries(recurringId) {
            if (!currentUserId) {
                alert("You must be logged in to delete transactions.");
                return;
            }
            if (confirm("Are you sure you want to delete this entire recurring series?")) {
                try {
                    const batch = writeBatch(db);
                    const q = query(collection(db, "users", currentUserId, "transactions"), where("recurringId", "==", recurringId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    alert("Recurring series deleted successfully.");
                } catch (e) {
                    console.error("Error deleting recurring series: ", e);
                    alert("Failed to delete recurring series. Please try again.");
                }
            }
        }

        async function exportTransactions() {
            if (!txns.length) {
                alert("No transactions to export.");
                return;
            }
            let csv = "Type,Category,Amount,Date,Comment\n";
            txns.forEach((t) => {
                const comment = t.comment ? `"${t.comment.replace(/"/g, '""')}"` : "";
                csv += `${t.type},${t.category},${t.amount},${t.date},${comment}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "transactions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        const logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
                alert("Failed to log out. Please try again.");
            }
        };

        window.onload = () => {
            const logoutButton = document.getElementById("logoutButton");
            if (logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }
        };

        async function deleteAllFilteredTransactions() {
            if (!currentUserId) {
                alert("You must be logged in to delete transactions.");
                return;
            }

            const category = document.getElementById("filterCategory").value;
            const type = document.getElementById("filterType").value;
            const range = document.getElementById("amountRange").value.split("-").map(x => parseFloat(x));
            
            const filteredTransactions = txns.filter(t => {
                const inCategory = !category || t.category === category;
                const inType = !type || t.type === type;
                const amount = parseFloat(t.amount);
                const inRange =
                    (isNaN(range[0]) && isNaN(range[1])) ||
                    ((!isNaN(range[0]) && amount >= range[0]) && (!isNaN(range[1]) && amount <= range[1]));
                return inCategory && inType && inRange;
            });

            if (filteredTransactions.length === 0) {
                alert("No transactions to delete.");
                return;
            }

            if (confirm(`Are you sure you want to delete ${filteredTransactions.length} transaction(s)? This action cannot be undone.`)) {
                try {
                    const batch = writeBatch(db);
                    filteredTransactions.forEach(txn => {
                        const docRef = doc(db, "users", currentUserId, "transactions", txn.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    alert(`${filteredTransactions.length} transaction(s) deleted successfully.`);
                } catch (e) {
                    console.error("Error deleting transactions: ", e);
                    alert("Failed to delete some transactions. Please try again.");
                }
            }
        }

        window.renderHistory = renderHistory;
        window.deleteTxn = deleteTxn;
        window.deleteRecurringSeries = deleteRecurringSeries;
        window.exportTransactions = exportTransactions;
        window.deleteAllFilteredTransactions = deleteAllFilteredTransactions;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
