<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transaction History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <style>
        .transaction-card {
            border: 1px solid #dee2e6;
            border-left-width: .25rem;
        }
        .transaction-card.income {
            border-left-color: #198754;
        }
        .transaction-card.expense {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="logo-head.png" alt="FinSight Logo" class="logo-header">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="input.html">
                            <i class="fas fa-plus-circle"></i> Add Transaction
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="history.html">
                            <i class="fas fa-list"></i> All Transactions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="budget.html"><i class="fas fa-chart-pie"></i> Budget</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="myprofile.html">
                            <i class="fas fa-user"></i> My Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutButton">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="header-container">
            <h2>Transaction History</h2>
        </div>

        <ul class="nav nav-tabs" id="historyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-transactions-tab" data-bs-toggle="tab" data-bs-target="#all-transactions" type="button" role="tab" aria-controls="all-transactions" aria-selected="true">All Transactions</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recurring-transactions-tab" data-bs-toggle="tab" data-bs-target="#recurring-transactions" type="button" role="tab" aria-controls="recurring-transactions" aria-selected="false">Recurring Transactions</button>
            </li>
        </ul>

        <div class="tab-content" id="historyTabsContent">
            <div class="tab-pane fade show active" id="all-transactions" role="tabpanel" aria-labelledby="all-transactions-tab">
                <div class="row mb-3 g-3 mt-2">
                    <div class="col-md-3">
                        <label for="filterCategory" class="form-label">Category</label>
                        <select id="filterCategory" class="form-select" onchange="renderHistory()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterType" class="form-label">Type</label>
                        <select id="filterType" class="form-select" onchange="renderHistory()">
                            <option value="">All</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="amountRange" class="form-label">Amount Range</label>
                        <input
                            type="text"
                            id="amountRange"
                            class="form-control"
                            placeholder="e.g., 100-1000"
                            onchange="renderHistory()"
                            title="Enter amount range like 100-1000, 100-, or -1000"
                        />
                    </div>
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Date Range</label>
                        <div class="input-group">
                            <input type="date" id="startDate" class="form-control" onchange="renderHistory()" title="Start Date">
                            <input type="date" id="endDate" class="form-control" onchange="renderHistory()" title="End Date">
                        </div>
                    </div>
                </div>
                <div id="historyContainer"></div>
                
                <div class="d-flex justify-content-start mt-3">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Export
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                        <li><a class="dropdown-item" href="#" onclick="exportTransactions('csv')">Export as CSV</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportTransactions('pdf')">Export as PDF</a></li>
                    </ul>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-danger" onclick="deleteAllFilteredTransactions()">
                        <i class="fas fa-trash-alt"></i> Delete Filtered
                    </button>
                </div>
            </div>
            <div class="tab-pane fade" id="recurring-transactions" role="tabpanel" aria-labelledby="recurring-transactions-tab">
                <div id="recurringHistoryContainer" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, deleteDoc, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { auth, db } from "./firebase-config.js";

        let currentUserId = null;
        let txns = [];
        let unsubscribeFromTransactions = null;

        onAuthStateChanged(auth, (user) => {
            if (unsubscribeFromTransactions) {
                unsubscribeFromTransactions();
            }

            if (user) {
                currentUserId = user.uid;
                const userTransactionsCollection = collection(db, "users", currentUserId, "transactions");
                
                unsubscribeFromTransactions = onSnapshot(query(userTransactionsCollection), (querySnapshot) => {
                    txns = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Sort transactions by date descending (newest first)
                    txns.sort((a, b) => new Date(b.date) - new Date(a.date));
                    renderCategoryFilter();
                    renderHistory();
                    renderRecurringHistory();
                }, (error) => {
                    console.error("Error listening to user transactions: ", error);
                    alert("Failed to load your transactions. Please try again.");
                });
            } else {
                currentUserId = null;
                txns = [];
                window.location.href = "index.html";
            }
        });

        function renderCategoryFilter() {
            const filter = document.getElementById("filterCategory");
            const currentCategory = filter.value; 
            const categories = [...new Set(txns.map(t => t.category))].sort();
            filter.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}" ${c === currentCategory ? 'selected' : ''}>${c}</option>`).join('');
        }

        function formatAmount(amount) {
            return parseFloat(amount).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderHistory() {
            const category = document.getElementById("filterCategory").value;
            const type = document.getElementById("filterType").value;
            const container = document.getElementById("historyContainer");
            container.innerHTML = "";
            
            const rangeInput = document.getElementById("amountRange").value.trim();
            const rangeParts = rangeInput.split("-").map(x => x.trim());
            const minAmount = rangeParts[0] ? parseFloat(rangeParts[0]) : NaN;
            const maxAmount = rangeParts.length > 1 && rangeParts[1] ? parseFloat(rangeParts[1]) : NaN;

            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            const filteredTxns = txns.filter(t => {
                const inCategory = !category || t.category === category;
                const inType = !type || t.type === type;
                
                const amount = parseFloat(t.amount);
                let inRange = true;
                if (!isNaN(minAmount) && amount < minAmount) {
                    inRange = false;
                }
                if (!isNaN(maxAmount) && amount > maxAmount) {
                    inRange = false;
                }
                
                const inDateRange = (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate);
                
                return inCategory && inType && inRange && inDateRange;
            });

            if (filteredTxns.length === 0) {
                container.innerHTML = '<p class="text-center text-muted mt-3">No transactions match your filters.</p>';
                return;
            }

            filteredTxns.forEach((t) => {
                const card = document.createElement("div");
                card.className = `card transaction-card mb-2 ${t.type.toLowerCase()}`;
                // --- SYNTAX FIX START ---
                card.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas ${t.type === 'Income' ? 'fa-arrow-up text-success' : 'fa-arrow-down text-danger'} me-3 fa-lg"></i>
                                <div>
                                    <h6 class="mb-0">${t.category}</h6>
                                    <small class="text-muted">${t.date}</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <h6 class="mb-0 ${t.type === 'Income' ? 'text-success' : 'text-danger'}">${t.type === "Income" ? '+' : '-'} Rs.${formatAmount(t.amount)}</h6>
                                <small class="text-muted">${t.comment || ""}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger ms-3" onclick="deleteTxn('${t.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                // --- SYNTAX FIX END ---
                container.appendChild(card);
            });
        }

        function renderRecurringHistory() {
            const recurringTxns = txns.filter(t => t.isRecurring);
            const container = document.getElementById("recurringHistoryContainer");
            container.innerHTML = "";

            if (recurringTxns.length === 0) {
                container.innerHTML = '<p class="text-center text-muted mt-3">You have no recurring transactions.</p>';
                return;
            }

            const recurringSeries = {};
            recurringTxns.forEach(t => {
                if (!recurringSeries[t.recurringId]) {
                    recurringSeries[t.recurringId] = [];
                }
                recurringSeries[t.recurringId].push(t);
            });

            for (const recurringId in recurringSeries) {
                const series = recurringSeries[recurringId];
                const firstTxn = series.sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                const card = document.createElement("div");
                card.className = `card transaction-card mb-2 ${firstTxn.type.toLowerCase()}`;
                // --- SYNTAX FIX START ---
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas ${firstTxn.type === 'Income' ? 'fa-arrow-up text-success' : 'fa-arrow-down text-danger'} fa-2x"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${firstTxn.category}</h6>
                                    <small class="text-muted">${firstTxn.frequency} - ${firstTxn.instances} times</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <h6 class="mb-0 ${firstTxn.type === 'Income' ? 'text-success' : 'text-danger'}">${firstTxn.type === "Income" ? '+' : '-'} Rs.${formatAmount(firstTxn.amount)}</h6>
                                <small class="text-muted">Starts on ${firstTxn.date}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" disabled>Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecurringSeries('${recurringId}')">Delete</button>
                            </div>
                        </div>
                    </div>`;
                // --- SYNTAX FIX END ---
                container.appendChild(card);
            }
        }

        async function deleteTxn(docId) {
            if (!currentUserId) return alert("You must be logged in.");
            if (confirm("Are you sure you want to delete this transaction?")) {
                try {
                    await deleteDoc(doc(db, "users", currentUserId, "transactions", docId));
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert("Failed to delete transaction. Please try again.");
                }
            }
        }

        async function deleteRecurringSeries(recurringId) {
            if (!currentUserId) return alert("You must be logged in.");
            if (confirm("Are you sure you want to delete this entire recurring series?")) {
                try {
                    const batch = writeBatch(db);
                    const q = query(collection(db, "users", currentUserId, "transactions"), where("recurringId", "==", recurringId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    alert("Recurring series deleted successfully.");
                } catch (e) {
                    console.error("Error deleting recurring series: ", e);
                    alert("Failed to delete recurring series. Please try again.");
                }
            }
        }

        async function exportTransactions(format) {
            const filteredTxns = getFilteredTxns();
            if (!filteredTxns.length) return alert("No transactions to export.");
            
            if (format === 'csv') {
                let csv = "Type,Category,Amount,Date,Comment\n";
                filteredTxns.forEach((t) => {
                    const comment = t.comment ? `"${t.comment.replace(/"/g, '""')}"` : "";
                    csv += `${t.type},${t.category},${t.amount},${t.date},${comment}\n`;
                });

                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", "transactions.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else if (format === 'pdf') {
                // PDF export logic here
                alert("PDF export is not yet implemented.");
            }
        }

        const logout = async () => {
            if (unsubscribeFromTransactions) unsubscribeFromTransactions();
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
            }
        };

        document.getElementById("logoutButton").addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });

        async function deleteAllFilteredTransactions() {
            if (!currentUserId) return alert("You must be logged in.");

            const category = document.getElementById("filterCategory").value;
            const type = document.getElementById("filterType").value;
            
            const rangeInput = document.getElementById("amountRange").value.trim();
            const rangeParts = rangeInput.split("-").map(x => x.trim());
            const minAmount = rangeParts[0] ? parseFloat(rangeParts[0]) : NaN;
            const maxAmount = rangeParts.length > 1 && rangeParts[1] ? parseFloat(rangeParts[1]) : NaN;
            
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            const filteredTransactions = txns.filter(t => {
                const inCategory = !category || t.category === category;
                const inType = !type || t.type === type;
                const amount = parseFloat(t.amount);
                let inRange = true;
                if (!isNaN(minAmount) && amount < minAmount) inRange = false;
                if (!isNaN(maxAmount) && amount > maxAmount) inRange = false;

                const inDateRange = (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate);

                return inCategory && inType && inRange && inDateRange;
            });

            if (filteredTransactions.length === 0) return alert("No transactions match the current filters.");

            if (confirm(`Delete ${filteredTransactions.length} transaction(s)? This action cannot be undone.`)) {
                try {
                    const batch = writeBatch(db);
                    filteredTransactions.forEach(txn => {
                        const docRef = doc(db, "users", currentUserId, "transactions", txn.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    alert(`${filteredTransactions.length} transaction(s) deleted successfully.`);
                } catch (e) {
                    console.error("Error deleting transactions: ", e);
                    alert("Failed to delete transactions. Please try again.");
                }
            }
        }

        // Expose functions to the global scope so inline onclick handlers can find them
        window.renderHistory = renderHistory;
        window.deleteTxn = deleteTxn;
        window.deleteRecurringSeries = deleteRecurringSeries;
        window.exportTransactions = exportTransactions;
        window.deleteAllFilteredTransactions = deleteAllFilteredTransactions;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>