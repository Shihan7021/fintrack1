<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transaction History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <!-- Header Menu Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <!-- Logo and Brand -->
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="logo-head.png" alt="FinSight Logo" class="logo-header">
            </a>
            
            <!-- Mobile Toggle Button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Menu Items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="input.html">
                            <i class="fas fa-plus-circle"></i> Add Transaction
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="history.html">
                            <i class="fas fa-list"></i> All Transactions
                        </a>
                    </li>
                </ul>
                
                <!-- Right Side Menu -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="exportTransactions()">
                            <i class="fas fa-download"></i> Export
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutButton">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="header-container">
            <h2>Transaction History</h2>
        </div>

        <div class="row mb-3 g-3">
            <div class="col-md-4">
                <label for="filterCategory" class="form-label">Category</label>
                <select id="filterCategory" class="form-select" onchange="renderHistory()">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="filterType" class="form-label">Type</label>
                <select id="filterType" class="form-select" onchange="renderHistory()">
                    <option value="">All</option>
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="amountRange" class="form-label">Amount Range</label>
                <input
                    type="text"
                    id="amountRange"
                    class="form-control"
                    placeholder="min-max"
                    onchange="renderHistory()"
                    title="Enter amount range like 100-1000"
                />
            </div>
        </div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Comment</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAl8wXLzjuHGHohU70LOoObJ7OZUhHpWDQ",
            authDomain: "finsight-567f4.firebaseapp.com",
            projectId: "finsight-567f4",
            storageBucket: "finsight-567f4.firebasestorage.app",
            messagingSenderId: "329662315678",
            appId: "1:329662315678:web:735fbacbca2818e0674f8f",
            measurementId: "G-3BYVY6PE64"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;

        let txns = [];
        let deletedTxnData = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                const userTransactionsCollection = collection(db, "users", currentUserId, "transactions");
                
                onSnapshot(query(userTransactionsCollection), (querySnapshot) => {
                    txns = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderCategoryFilter();
                    renderHistory();
                }, (error) => {
                    console.error("Error listening to user transactions: ", error);
                    alert("Failed to load your transactions. Please try again.");
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function renderCategoryFilter() {
            const filter = document.getElementById("filterCategory");
            const categories = [...new Set(txns.map(t => t.category))];
            filter.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function formatAmount(amount) {
            return parseFloat(amount).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderHistory() {
            const category = document.getElementById("filterCategory").value;
            const type = document.getElementById("filterType").value;
            const range = document.getElementById("amountRange").value.split("-").map(x => parseFloat(x));
            const tbody = document.getElementById("historyTableBody");
            tbody.innerHTML = "";

            txns.forEach((t) => {
                const inCategory = !category || t.category === category;
                const inType = !type || t.type === type;
                const amount = parseFloat(t.amount);
                const inRange =
                    (isNaN(range[0]) && isNaN(range[1])) ||
                    ((!isNaN(range[0]) && amount >= range[0]) && (!isNaN(range[1]) && amount <= range[1]));

                if (inCategory && inType && inRange) {
                    const row = document.createElement("tr");
                    row.className = t.type === "Income" ? "income-row" : "expense-row";
                    row.innerHTML = `
                        <td>${t.type}</td>
                        <td>${t.category}</td>
                        <td>Rs.${formatAmount(t.amount)}</td>
                        <td>${t.date}</td>
                        <td>${t.comment || ""}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteTxn('${t.id}')">Delete</button></td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        async function deleteTxn(docId) {
            if (!currentUserId) {
                alert("You must be logged in to delete transactions.");
                return;
            }
            if (confirm("Are you sure you want to delete this transaction?")) {
                try {
                    const txnToDelete = txns.find(t => t.id === docId);
                    if (txnToDelete) {
                        deletedTxnData = { ...txnToDelete };
                    }
                    await deleteDoc(doc(db, "users", currentUserId, "transactions", docId));
                    showUndoToast();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert("Failed to delete transaction. Please try again.");
                }
            }
        }

        function showUndoToast() {
            const toast = document.getElementById("undoToast");
            if (toast) {
                toast.style.display = "block";
                setTimeout(() => {
                    toast.style.display = "none";
                    deletedTxnData = null;
                }, 5000);
            }
        }

        async function undoDelete() {
            if (deletedTxnData && currentUserId) {
                try {
                    const { id, ...txnDataWithoutId } = deletedTxnData;
                    await addDoc(collection(db, "users", currentUserId, "transactions"), txnDataWithoutId);
                    document.getElementById("undoToast").style.display = "none";
                    deletedTxnData = null;
                    alert("Transaction restored successfully.");
                } catch (e) {
                    console.error("Error restoring transaction: ", e);
                    alert("Failed to restore transaction. Please try again.");
                }
            }
        }

        async function exportTransactions() {
            if (!txns.length) {
                alert("No transactions to export.");
                return;
            }
            let csv = "Type,Category,Amount,Date,Comment\n";
            txns.forEach((t) => {
                const comment = t.comment ? `"${t.comment.replace(/"/g, '""')}"` : "";
                csv += `${t.type},${t.category},${t.amount},${t.date},${comment}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "transactions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        const logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
                alert("Failed to log out. Please try again.");
            }
        };

        window.onload = () => {
            const logoutButton = document.getElementById("logoutButton");
            if (logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }
        };

        window.renderHistory = renderHistory;
        window.deleteTxn = deleteTxn;
        window.undoDelete = undoDelete;
        window.exportTransactions = exportTransactions;
    </script>
</body>
</html>
